# 热浪的定义

## 聚类计算的核心实现

### 1. 热浪聚类的定义

你的代码中，**热浪聚类**的定义是：

- **空间上连续**的热浪格点组成的区域
- 热浪格点是指：实际温度超过该格点历史同期（同月同日）90 百分位阈值的格点
- 必须满足**连续至少 3 天**的条件（通过`apply_consecutive_days_filter`函数实现）

### 2. 聚类识别的核心算法

聚类识别主要在`find_drought_clusters`函数中实现（第 527-681 行），算法流程如下：

#### 步骤 1：数据预处理

```python
# 计算温度差值作为聚类输入
temp_diff = T_actual_filtered[index, :, :] - T_threshold_filtered[index, :, :]
data_for_clustering = temp_diff.astype(np.float32)
data_for_clustering[data_for_clustering <= 0] = np.nan  # 只保留热浪格点
```

#### 步骤 2：空间连通性检测

使用**种子填充算法**（flood-fill algorithm）识别空间上连通的格点：

1. **找到所有热浪格点**：

   ```python
   idx_lat, idx_lon = np.where(np.isfinite(data_matrix))
   linked_indices = list(zip(idx_lat, idx_lon))
   ```

2. **对每个未分类的热浪格点**：

   - 作为种子点开始新的聚类
   - 检查其 8 邻域（上下左右及对角线）是否有其他热浪格点
   - 递归地将连通的格点加入同一聚类

3. **连通性判断**：

   ```python
   def check_drought_in_surroundings(current_pixel, linked_indices, data_matrix, periodic_bool):
       # 检查8邻域格点是否也是热浪格点
       for x, y in [(n+i, m+j) for i in (-1,0,1) for j in (-1,0,1) if i!=0 or j!=0]:
           if (x, y) in linked_indices:
               surrounding_drought_pixels.append((x, y))
   ```

### 3. 聚类特征计算

对每个识别出的聚类，计算以下特征：

#### 面积计算

```python
def find_cluster_area(coordinates, lons, lats, resolution_lon, resolution_lat):
    # 计算每个格点的实际面积（考虑地球曲率）
    area = (R**2) * (lon_max - lon_min) * (np.sin(lat_max) - np.sin(lat_min))
```

#### 质心计算

```python
def find_weighed_centroid(lats_array, lons_array, intensities, lons, lats):
    # 使用温度差值作为权重计算加权质心
    centroid_lat = np.average(lats_array, weights=intensities)
    centroid_lon = np.average(lons_array, weights=intensities)
```

#### 强度计算

```python
# 强度 = 温度差值 × 格点面积
intensity = weight * area_per_grid
```

### 4. 聚类过滤

通过`filter_drought_clusters`函数过滤小聚类：

```python
# 过滤条件：
# 1. 面积 >= minimum_area_threshold (默认100 km²)
# 2. 质心不在撒哈拉沙漠区域
if cluster_area >= area_threshold and not in_sahara:
    # 保留该聚类
```

### 5. 时间维度追踪

在`track_heatwave_clusters_and_save`函数中实现聚类的时间追踪：

```python
def clusters_are_connected(info1, info2, distance_threshold=1):
    # 判断两个聚类是否相连：是否共享或相邻格点
    for y1, x1 in coords1:
        for y2, x2 in coords2:
            if (abs(y1 - y2) <= distance_threshold and
                abs(x1 - x2) <= distance_threshold):
                return True
```

## 聚类的具体定义总结

1. **空间定义**：空间上相邻（8 邻域）的热浪格点组成一个聚类
2. **时间定义**：连续至少 3 天的热浪格点才被认为是有效热浪
3. **阈值定义**：实际温度超过历史同期 90 百分位阈值的格点
4. **面积阈值**：聚类面积必须 ≥100 km²
5. **地理限制**：质心不在撒哈拉沙漠的聚类

这个算法能够有效识别出空间上连续、时间上持续的热浪事件，并计算其面积、强度、质心等特征，为热浪事件的时空分析提供了基础。
