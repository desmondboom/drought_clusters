# 热浪聚类分析工具集

本文件夹包含用于验证和调试热浪聚类分析结果的实用工具脚本。这些工具覆盖了从数据预处理到最终结果验证的完整流程。

## 工具列表

### 1. 数据调试工具

#### `debug_data.py` - 数据预处理调试

**功能**：调试第一步数据预处理的结果，检查热浪掩膜生成是否正确。

**核心特性**：

- 验证连续 3 天筛选后的数据质量
- 检查温度阈值计算是否合理
- 分析热浪格点的时空分布特征
- 生成可视化图表展示数据质量

**使用方法**：

```bash
python utils/debug_data.py
```

**输出内容**：

- **数据基本信息**：时间范围、数据形状、维度信息
- **温度数据统计**：实际温度 vs 阈值温度的范围和分布
- **热浪掩膜统计**：热浪格点总数、比例、空间分布
- **每日热浪情况**：有热浪的天数、最大日热浪格点数
- **温度差异分析**：正差异格点数量和比例
- **可视化图表**：保存为 `debug_heatwave_data.png`

**适用场景**：

- 验证数据预处理是否正确
- 检查连续 3 天筛选效果
- 调试温度阈值计算问题
- 可视化温度分布和热浪掩膜

---

#### `debug_step2.py` - 第二步时间筛选调试

**功能**：调试第二步聚类识别中的时间筛选逻辑，确保正确提取 2011-2020 年 5-9 月的数据。

**核心特性**：

- 验证时间筛选逻辑的正确性
- 检查筛选后数据的完整性
- 分析热浪在目标时间段内的分布
- 对比筛选前后的数据差异

**使用方法**：

```bash
python utils/debug_step2.py
```

**输出内容**：

- **原始数据信息**：完整数据集的时间范围和形状
- **目标时间范围**：2011-2020 年 5-9 月的筛选条件
- **筛选结果统计**：筛选前后的数据量对比
- **热浪情况分析**：筛选后数据中的热浪格点统计
- **前 10 天检查**：详细展示筛选后前 10 天的热浪情况

**适用场景**：

- 验证时间筛选逻辑是否正确
- 检查筛选后的数据是否包含热浪
- 调试第二步的数据传递问题
- 确保数据时间轴的一致性

---

### 2. 连续 3 天筛选验证工具

#### `test_consecutive_filter.py` - 连续 3 天筛选功能测试

**功能**：测试连续 3 天筛选算法的正确性，验证各种边界情况。

**核心特性**：

- 测试不同长度的连续期识别
- 验证边界条件处理
- 检查算法逻辑的正确性
- 提供多种测试用例

**使用方法**：

```bash
python utils/test_consecutive_filter.py
```

**输出内容**：

- **测试用例 1**：包含连续 3 天的情况
- **测试用例 2**：只有 1-2 天的情况（应被过滤）
- **测试用例 3**：边界情况（序列开头和结尾）
- **测试用例 4**：全为 1 的情况
- **测试用例 5**：全为 0 的情况

**适用场景**：

- 验证连续 3 天筛选算法
- 测试边界条件处理
- 确保筛选逻辑的正确性

---

#### `verify_consecutive_filter.py` - 连续 3 天筛选效果验证

**功能**：验证连续 3 天筛选在实际数据上的效果，分析筛选前后的差异。

**核心特性**：

- 分析连续热浪期的分布特征
- 检查夏季热浪模式
- 统计筛选效果和保留比例
- 生成可视化验证图表

**使用方法**：

```bash
python utils/verify_consecutive_filter.py
```

**输出内容**：

- **基本统计**：总格点数、热浪格点数、热浪比例
- **每日热浪统计**：有热浪的天数、最大日热浪格点数、平均日热浪格点数
- **连续热浪期分析**：连续期长度分布、最长连续期
- **夏季热浪模式**：夏季(6-8 月)的热浪特征
- **可视化结果**：保存为 `verify_consecutive_filter.png`

**适用场景**：

- 验证连续 3 天筛选的实际效果
- 分析热浪的时空分布特征
- 检查筛选后的数据质量

---

### 3. 结果验证工具

#### `quick_check.py` - 快速检查

**功能**：快速检查 pck 文件的基本信息，提供简洁的统计报告。

**核心特性**：

- 快速统计文件数量和日期范围
- 检查文件完整性
- 提供样本文件的基本信息
- 适合日常监控和初步检查

**使用方法**：

```bash
python utils/quick_check.py
```

**输出内容**：

- **文件统计**：Mask、Dictionary、Count 文件数量
- **日期范围**：处理结果的时间覆盖范围
- **样本检查**：随机选择几个文件进行详细检查
- **基本信息**：文件形状、热浪格点数、聚类数等

**适用场景**：

- 快速了解处理结果概况
- 初步检查是否有明显问题
- 日常监控处理进度
- 验证文件生成是否完整

---

#### `verify_pck.py` - 详细验证

**功能**：对 pck 文件进行全面的正确性验证和质量检查。

**核心特性**：

- 全面的文件完整性检查
- 详细的聚类质量分析
- 日期一致性验证
- 统计聚类特征分布

**使用方法**：

```bash
python utils/verify_pck.py
```

**输出内容**：

- **文件完整性检查**：文件数量、日期范围、文件大小
- **样本文件详细分析**：形状、类型、热浪格点数、聚类数
- **聚类质量统计**：面积、强度、质心坐标分布
- **日期一致性检查**：验证日期序列的连续性

**适用场景**：

- 全面验证处理结果的正确性
- 检查数据质量和完整性
- 生成详细的分析报告
- 调试聚类识别问题

---

#### `visualize_clusters.py` - 可视化验证

**功能**：生成热浪聚类结果的可视化图表，直观展示分析结果。

**核心特性**：

- 热浪分布图对比（原始掩膜 vs 聚类结果）
- 聚类统计图表（时间序列、分布直方图）
- 特定日期的详细检查
- 支持自定义日期和保存路径

**使用方法**：

```bash
python utils/visualize_clusters.py
```

**输出内容**：

- **热浪分布图**：原始掩膜与聚类结果的对比
- **聚类统计图表**：时间序列、面积分布、强度分布
- **特定日期检查**：指定日期的详细可视化
- **保存图表**：可保存为 PNG 格式用于报告

**适用场景**：

- 直观展示热浪聚类结果
- 检查聚类的空间分布特征
- 生成用于报告的可视化图表
- 验证聚类识别的正确性

---

## 使用流程建议

### 1. 数据预处理阶段

```bash
# 运行数据预处理（包含连续3天筛选）
python src/01_data_preprocessing.py

# 验证预处理结果
python utils/debug_data.py

# 测试连续3天筛选算法
python utils/test_consecutive_filter.py

# 验证连续3天筛选效果
python utils/verify_consecutive_filter.py
```

**关键检查点**：

- 确认热浪格点比例合理（3-12%）
- 验证连续 3 天筛选效果（保留比例约 50%）
- 检查温度阈值计算正确性

### 2. 聚类识别阶段

```bash
# 调试时间筛选逻辑
python utils/debug_step2.py

# 运行聚类识别
mpirun -host localhost -np 4 python src/02_calculate_drought_clusters_parallel.py

# 快速检查结果
python utils/quick_check.py
```

**关键检查点**：

- 确认时间筛选正确（2011-2020 年 5-9 月）
- 验证聚类识别成功（非零聚类数）
- 检查文件生成完整性

### 3. 结果验证阶段

```bash
# 详细验证结果
python utils/verify_pck.py

# 可视化展示
python utils/visualize_clusters.py
```

**关键检查点**：

- 确认聚类质量（面积、强度分布合理）
- 验证日期一致性
- 检查空间分布特征

### 4. 事件追踪阶段

```bash
# 运行事件追踪
python src/03_process_drought_clusters.py

# 最终验证
python utils/verify_pck.py
```

**关键检查点**：

- 确认事件追踪逻辑正确
- 验证跨年断点处理
- 检查事件持续时间合理

## 输出文件说明

### 调试输出文件

- **`debug_heatwave_data.png`** - 数据预处理可视化结果

  - 包含实际温度、阈值温度、温度差异、热浪掩膜四个子图
  - 用于验证数据预处理的质量和正确性

- **`verify_consecutive_filter.png`** - 连续 3 天筛选效果验证图
  - 展示筛选前后的热浪分布对比
  - 包含时间序列和空间分布分析

### 控制台输出

- **统计信息**：数据形状、时间范围、格点数量等基本信息
- **质量指标**：热浪比例、聚类数量、面积分布等关键指标
- **诊断结果**：错误信息、警告提示、建议修复方案

## 常见问题排查

### 1. 热浪格点数为 0

**可能原因**：

- 数据预处理步骤出错
- 温度阈值计算错误
- 连续 3 天筛选过于严格

**排查步骤**：

```bash
# 1. 检查原始数据
python utils/debug_data.py

# 2. 验证温度阈值计算
# 检查 T_actual 和 T_threshold 的范围是否合理

# 3. 测试连续3天筛选
python utils/test_consecutive_filter.py
```

### 2. 聚类数量为 0

**可能原因**：

- 面积阈值设置过高
- 热浪掩膜数据问题
- 聚类算法参数错误

**排查步骤**：

```bash
# 1. 检查面积阈值设置
# 查看 src/definitions.yaml 中的 minimum_area_threshold

# 2. 验证热浪掩膜
python utils/verify_pck.py

# 3. 检查聚类算法
# 确认 drought_clusters_utils.py 中的面积计算正确
```

### 3. 文件数量不匹配

**可能原因**：

- 时间筛选逻辑错误
- 日期范围设置问题
- 文件保存路径错误

**排查步骤**：

```bash
# 1. 调试时间筛选
python utils/debug_step2.py

# 2. 检查日期范围
# 确认 start_year 和 end_year 设置正确

# 3. 验证文件路径
# 检查 clusters_output 目录结构
```

### 4. 日期范围错误

**可能原因**：

- 时间轴处理错误
- 日期计算逻辑问题
- 时区设置不当

**排查步骤**：

```bash
# 1. 检查时间轴
python utils/debug_data.py

# 2. 验证日期计算
# 检查 num2date 和 date2num 的使用

# 3. 确认时区设置
# 检查 NetCDF 文件中的时间单位
```

### 5. 连续 3 天筛选效果异常

**可能原因**：

- 筛选算法逻辑错误
- 边界条件处理不当
- 数据时间序列问题

**排查步骤**：

```bash
# 1. 测试筛选算法
python utils/test_consecutive_filter.py

# 2. 验证筛选效果
python utils/verify_consecutive_filter.py

# 3. 检查数据时间序列
# 确认数据的时间连续性
```

### 6. 聚类面积计算错误

**可能原因**：

- 分辨率参数错误
- 面积计算公式问题
- 坐标系转换错误

**排查步骤**：

```bash
# 1. 检查分辨率计算
# 确认 res_lon 和 res_lat 的计算正确

# 2. 验证面积公式
# 检查 find_gridcell_area 函数的实现

# 3. 测试面积计算
# 用已知值验证面积计算结果
```

## 注意事项

### 运行环境要求

1. **Python 版本**：建议使用 Python 3.7+
2. **依赖库**：numpy、netCDF4、matplotlib、yaml、mpi4py
3. **内存要求**：大数据集可能需要 8GB+内存
4. **存储空间**：确保有足够空间存储输出文件

### 使用建议

1. **运行顺序**：严格按照上述流程顺序运行工具
2. **数据路径**：确保所有数据文件路径正确且可访问
3. **文件权限**：确保有读取数据文件和写入输出文件的权限
4. **并行运行**：聚类识别步骤建议使用 MPI 并行运行
5. **错误处理**：遇到错误时先查看控制台输出，再参考排查指南

### 性能优化

1. **内存管理**：大数据集处理时注意内存使用
2. **并行处理**：聚类识别使用多进程加速
3. **文件 I/O**：避免频繁读写大文件
4. **缓存机制**：重复计算时考虑使用缓存

## 工具开发指南

### 添加新工具

如需添加新的验证工具，建议遵循以下规范：

1. **命名规范**：使用描述性的文件名，如 `check_xxx.py`
2. **文档说明**：添加详细的函数和类文档
3. **错误处理**：包含完善的异常处理机制
4. **输出格式**：提供清晰、一致的输出格式
5. **参数配置**：支持命令行参数和配置文件

### 代码结构

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
工具描述和功能说明
"""

import numpy as np
import matplotlib.pyplot as plt
# 其他必要的导入

def main_function():
    """主要功能函数"""
    pass

def helper_function():
    """辅助功能函数"""
    pass

if __name__ == "__main__":
    main_function()
```

### 测试要求

1. **单元测试**：为每个函数编写测试用例
2. **集成测试**：测试工具与整个流程的集成
3. **边界测试**：测试各种边界条件和异常情况
4. **性能测试**：确保工具在合理时间内完成

## 更新日志

### v1.0.0 (2024-09-05)

- 初始版本发布
- 包含基础的数据调试和结果验证工具
- 支持连续 3 天筛选功能验证
- 提供完整的可视化分析工具

### 未来计划

- 添加更多统计分析工具
- 支持不同数据格式的输入
- 优化大数据的处理性能
- 增加交互式可视化功能
