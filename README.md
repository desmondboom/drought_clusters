# çƒ­æµªè¯†åˆ«ä¸è¿½è¸ªç³»ç»Ÿï¼ˆERA5 æ•°æ®ç‰ˆï¼‰

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäº ERA5 å†åˆ†ææ•°æ®çš„çƒ­æµªè¯†åˆ«ä¸è¿½è¸ªç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«çƒ­æµªäº‹ä»¶ã€è¿›è¡Œç©ºé—´èšç±»åˆ†æï¼Œå¹¶è¿½è¸ªçƒ­æµªäº‹ä»¶åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„æ¼”åŒ–è¿‡ç¨‹ã€‚

## ğŸŒŸ ä¸»è¦åŠŸèƒ½

- **åŠ¨æ€é˜ˆå€¼è®¡ç®—**ï¼šåŸºäºå†å²åŒæœŸæ•°æ®è®¡ç®— 90 ç™¾åˆ†ä½åŠ¨æ€é˜ˆå€¼
- **è¿ç»­ 3 å¤©ç­›é€‰**ï¼šç¡®ä¿çƒ­æµªäº‹ä»¶è‡³å°‘æŒç»­ 3 å¤©ï¼Œç¬¦åˆæ°”è±¡å­¦å®šä¹‰
- **ç©ºé—´èšç±»è¯†åˆ«**ï¼šè¯†åˆ«ç©ºé—´ä¸Šè¿ç»­çš„çƒ­æµªåŒºåŸŸ
- **æ—¶é—´äº‹ä»¶è¿½è¸ª**ï¼šè¿½è¸ªçƒ­æµªäº‹ä»¶åœ¨æ—¶é—´ç»´åº¦ä¸Šçš„æ¼”åŒ–
- **è·¨å¹´è¾¹ç•Œå¤„ç†**ï¼šé¿å…å°†ä¸åŒå¹´ä»½çš„çƒ­æµªäº‹ä»¶é”™è¯¯è¿æ¥
- **å¹¶è¡Œè®¡ç®—æ”¯æŒ**ï¼šæ”¯æŒ MPI å¹¶è¡Œå¤„ç†ï¼Œæé«˜è®¡ç®—æ•ˆç‡

## ğŸ“ é¡¹ç›®ç»“æ„

```txt
drought_clusters/
â”‚
â”œâ”€â”€ data/                                    # æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ era5_daily_mean_198005-202009_CHINA.nc    # åŸå§‹ERA5æ•°æ®
â”‚   â”œâ”€â”€ era5_daily_mean_201105-201109_CHINA.nc    # æ°”å€™åŸºå‡†æœŸæ•°æ®
â”‚   â””â”€â”€ processed/
â”‚       â””â”€â”€ heatwave_processed.nc                  # é¢„å¤„ç†åçš„çƒ­æµªæ•°æ®
â”‚
â”œâ”€â”€ clusters_output/                         # è¾“å‡ºç›®å½•ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”‚   â””â”€â”€ ERA5/China/heatwave/90p/
â”‚       â”œâ”€â”€ heatwave-dictionary_*.pck       # æ¯æ—¥èšç±»å­—å…¸æ–‡ä»¶
â”‚       â”œâ”€â”€ heatwave-mask_*.pck             # æ¯æ—¥çƒ­æµªæ©è†œæ–‡ä»¶
â”‚       â”œâ”€â”€ heatwave-count_*.pck            # æ¯æ—¥èšç±»æ•°é‡æ–‡ä»¶
â”‚       â””â”€â”€ result/
â”‚           â””â”€â”€ tracked_clusters_dictionary_2011-2020.pck  # æœ€ç»ˆè¿½è¸ªç»“æœ
â”‚
â”œâ”€â”€ src/                                     # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ 01_data_preprocessing.py            # æ•°æ®é¢„å¤„ç†è„šæœ¬
â”‚   â”œâ”€â”€ 02_calculate_heatwave_clusters_parallel.py  # çƒ­æµªèšç±»è¯†åˆ«ï¼ˆå¹¶è¡Œï¼‰
â”‚   â”œâ”€â”€ 03_process_heatwave_clusters.py     # çƒ­æµªäº‹ä»¶è¿½è¸ª
â”‚   â”œâ”€â”€ heatwave_clusters_utils.py          # çƒ­æµªèšç±»å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ definitions.yaml                    # é…ç½®æ–‡ä»¶
â”‚
â”œâ”€â”€ environment.yaml                        # Condaç¯å¢ƒé…ç½®
â”œâ”€â”€ LICENSE                                 # è®¸å¯è¯æ–‡ä»¶
â””â”€â”€ README.md                              # é¡¹ç›®è¯´æ˜æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒé…ç½®

ç¡®ä¿å·²å®‰è£… Miniconda æˆ– Anacondaï¼Œç„¶ååˆ›å»ºé¡¹ç›®ç¯å¢ƒï¼š

```bash
conda env create -f environment.yaml
conda activate heatwave
```

### 2. æ•°æ®å‡†å¤‡

å°† ERA5 æ•°æ®æ–‡ä»¶æ”¾ç½®åœ¨ `data/` ç›®å½•ä¸‹ï¼š

- **ä¸»æ•°æ®æ–‡ä»¶**ï¼š`era5_daily_mean_198005-202009_CHINA.nc`ï¼ˆ1980-2020 å¹´å®Œæ•´æ•°æ®ï¼‰
- **æ°”å€™åŸºå‡†æ–‡ä»¶**ï¼š`era5_daily_mean_201105-201109_CHINA.nc`ï¼ˆ2011-2019 å¹´ 5-9 æœˆæ•°æ®ï¼Œç”¨äºè®¡ç®—é˜ˆå€¼ï¼‰

ç¡®ä¿ NetCDF æ–‡ä»¶åŒ…å«ä»¥ä¸‹å˜é‡ï¼š

- `t2m`ï¼š2 ç±³æ°”æ¸©ï¼ˆå•ä½ï¼šå¼€å°”æ–‡ï¼‰
- `lat`ï¼šçº¬åº¦
- `lon`ï¼šç»åº¦
- `time`ï¼šæ—¶é—´

### 3. é…ç½®å‚æ•°

ç¼–è¾‘ `src/definitions.yaml` æ–‡ä»¶ï¼Œæ ¹æ®éœ€è¦è°ƒæ•´å‚æ•°ï¼š

```yaml
# æ•°æ®é›†ä¿¡æ¯
dataset: ERA5
region: China

# çƒ­æµªå®šä¹‰
drought_metric: heatwave
drought_threshold: 90p # 90ç™¾åˆ†ä½é˜ˆå€¼

# è¾“å…¥æ–‡ä»¶è·¯å¾„
drought_metric_path: ./data/processed/
drought_metric_file_name: heatwave_processed.nc

# å˜é‡åç§°
lat_var: lat
lon_var: lon

# æ—¶é—´èŒƒå›´
start_year: 2011
end_year: 2020

# èšç±»å‚æ•°
minimum_area_threshold: 100 # æœ€å°é¢ç§¯é˜ˆå€¼ï¼ˆkmÂ²ï¼‰
periodic_bool: False # æ˜¯å¦å‘¨æœŸæ€§è¾¹ç•Œ

# è¾“å‡ºè·¯å¾„
clusters_partial_path: ./clusters_output
```

## ğŸ”§ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ•°æ®é¢„å¤„ç†

```bash
python src/01_data_preprocessing.py
```

**åŠŸèƒ½è¯´æ˜ï¼š**

- è®¡ç®—å®é™…æ¸©åº¦ `T_actual`
- åŸºäºå†å²åŒæœŸæ•°æ®è®¡ç®— 90 ç™¾åˆ†ä½åŠ¨æ€é˜ˆå€¼ `T_threshold`
- ç”ŸæˆäºŒå€¼çƒ­æµªæ©è†œ `heatwave_mask`
- åº”ç”¨è¿ç»­ 3 å¤©ç­›é€‰ï¼Œç¡®ä¿çƒ­æµªäº‹ä»¶è‡³å°‘æŒç»­ 3 å¤©
- è¾“å‡ºå¤„ç†åçš„ NetCDF æ–‡ä»¶ï¼š`data/processed/heatwave_processed.nc`

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
åº”ç”¨è¿ç»­3å¤©ç­›é€‰...
å¤„ç† 201 x 161 = 32361 ä¸ªæ ¼ç‚¹...
å·²å¤„ç† 10000/32361 ä¸ªæ ¼ç‚¹ (30.9%)
å·²å¤„ç† 20000/32361 ä¸ªæ ¼ç‚¹ (61.8%)
å·²å¤„ç† 30000/32361 ä¸ªæ ¼ç‚¹ (92.7%)
åŸå§‹çƒ­æµªæ ¼ç‚¹æ€»æ•°: 1234567
ç­›é€‰åçƒ­æµªæ ¼ç‚¹æ€»æ•°: 987654
ä¿ç•™æ¯”ä¾‹: 80.00%
å¤„ç†å®Œæˆï¼Œæ•°æ®ä¿å­˜ä¸ºï¼š./data/processed/heatwave_processed.nc
```

### æ­¥éª¤ 2ï¼šçƒ­æµªèšç±»è¯†åˆ«ï¼ˆå¹¶è¡Œï¼‰

```bash
mpirun -np 4 python src/02_calculate_heatwave_clusters_parallel.py
```

**åŠŸèƒ½è¯´æ˜ï¼š**

- å¯¹æ¯ä¸ªæ—¶é—´æ­¥è¿›è¡Œç©ºé—´èšç±»åˆ†æ
- è¯†åˆ«ç©ºé—´ä¸Šè¿ç»­çš„çƒ­æµªåŒºåŸŸ
- è®¡ç®—èšç±»é¢ç§¯ã€å¼ºåº¦ã€è´¨å¿ƒç­‰ç‰¹å¾
- è¿‡æ»¤å°äºé¢ç§¯é˜ˆå€¼çš„èšç±»
- æ”¯æŒ MPI å¹¶è¡Œè®¡ç®—

**å‚æ•°è¯´æ˜ï¼š**

- `-np 4`ï¼šä½¿ç”¨ 4 ä¸ª CPU æ ¸å¿ƒï¼ˆå¯æ ¹æ®ç³»ç»Ÿé…ç½®è°ƒæ•´ï¼‰

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
[Rank 0] 1/378 | global 1/1510 | date 20110501: heatwave pixels = 1234
[Rank 0] saved 20110501 | clusters=5 | step=2.34s
[Rank 1] 1/378 | global 2/1510 | date 20110502: heatwave pixels = 987
[Rank 1] saved 20110502 | clusters=3 | step=1.89s
...
```

### æ­¥éª¤ 3ï¼šçƒ­æµªäº‹ä»¶è¿½è¸ª

```bash
python src/03_process_heatwave_clusters.py
```

**åŠŸèƒ½è¯´æ˜ï¼š**

- éå†æ‰€æœ‰æ—¶é—´æ­¥çš„èšç±»æ•°æ®
- åŸºäºç©ºé—´é‡å åº¦è¿½è¸ªçƒ­æµªäº‹ä»¶
- å¤„ç†è·¨å¹´è¾¹ç•Œï¼Œé¿å…é”™è¯¯è¿æ¥
- è®¡ç®—äº‹ä»¶æŒç»­æ—¶é—´ã€æœ€å¤§é¢ç§¯ã€æ€»å¼ºåº¦ç­‰ç‰¹å¾
- ç”Ÿæˆæœ€ç»ˆçš„çƒ­æµªäº‹ä»¶å­—å…¸

**è¾“å‡ºç¤ºä¾‹ï¼š**

```
ğŸ“… å®é™…èšç±»æ–‡ä»¶æ—¥æœŸèŒƒå›´: 2011-05-01 åˆ° 2020-09-30
ğŸ“Š å®é™…æ–‡ä»¶æ•°é‡: 1510
å¼€å§‹è¿½è¸ªçƒ­æµªäº‹ä»¶...
ğŸ” æœç´¢è·¯å¾„: ./clusters_output/ERA5/China/heatwave/90p
ğŸ” æ‰¾åˆ°æ–‡ä»¶æ•°é‡: 1510
ğŸ“Š æˆåŠŸè§£ææ—¥æœŸçš„æ–‡ä»¶æ•°é‡: 1510
ğŸ“Š æ‰¾åˆ° 1510 ä¸ªèšç±»æ–‡ä»¶
å¤„ç†è¿›åº¦: 1/1510 - 2011-05-01
å¤„ç†è¿›åº¦: 101/1510 - 2011-08-09
...
è¾¹ç•Œé‡ç½®: 2012-05-01
è¾¹ç•Œé‡ç½®: 2013-05-01
...
âœ… å…±è¯†åˆ«çƒ­æµªäº‹ä»¶æ•°ï¼š74278
âœ… çƒ­æµªè¿½è¸ªæ•°æ®ä¿å­˜è‡³ï¼š./clusters_output/ERA5/China/heatwave/90p/result/tracked_clusters_dictionary_2011-2020.pck
âœ… Done tracking heatwave clusters.
```

## ğŸ“Š è¾“å‡ºç»“æœ

### ä¸­é—´æ–‡ä»¶

æ¯ä¸ªæ—¶é—´æ­¥ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶ï¼š

- `heatwave-dictionary_YYYYMMDD.pck`ï¼šèšç±»ç‰¹å¾å­—å…¸
- `heatwave-mask_YYYYMMDD.pck`ï¼šçƒ­æµªæ©è†œçŸ©é˜µ
- `heatwave-count_YYYYMMDD.pck`ï¼šèšç±»æ•°é‡

### æœ€ç»ˆç»“æœ

`tracked_clusters_dictionary_2011-2020.pck` åŒ…å«æ‰€æœ‰çƒ­æµªäº‹ä»¶çš„å®Œæ•´ä¿¡æ¯ï¼š

```python
{
    0: {
        "start": datetime(2011, 5, 1),
        "end": datetime(2011, 5, 2),
        "duration": 2,                    # æŒç»­æ—¶é—´ï¼ˆå¤©ï¼‰
        "total_intensity": -2325356.61,   # æ€»å¼ºåº¦
        "max_area": 1041331,             # æœ€å¤§é¢ç§¯ï¼ˆkmÂ²ï¼‰
        "centroid_trajectory": {         # è´¨å¿ƒè½¨è¿¹
            datetime(2011, 5, 1): (lon, lat),
            datetime(2011, 5, 2): (lon, lat)
        },
        "daily_coordinates": {           # æ¯æ—¥æ ¼ç‚¹åæ ‡
            datetime(2011, 5, 1): [(y1, x1), (y2, x2), ...],
            datetime(2011, 5, 2): [(y1, x1), (y2, x2), ...]
        }
    },
    # ... æ›´å¤šäº‹ä»¶
}
```

## ğŸ” ç»“æœéªŒè¯

### åŸºæœ¬ç»Ÿè®¡

```python
import pickle

# åŠ è½½ç»“æœ
with open('clusters_output/ERA5/China/heatwave/90p/result/tracked_clusters_dictionary_2011-2020.pck', 'rb') as f:
    events = pickle.load(f)

print(f"æ€»äº‹ä»¶æ•°é‡: {len(events):,}")
print(f"å¹³å‡æŒç»­æ—¶é—´: {np.mean([e['duration'] for e in events.values()]):.1f} å¤©")
print(f"æœ€å¤§é¢ç§¯: {max([e['max_area'] for e in events.values()]):,.0f} kmÂ²")
```

### å¹´åº¦ç»Ÿè®¡

```python
# æŒ‰å¹´åº¦ç»Ÿè®¡
yearly_events = {}
for event in events.values():
    year = event['start'].year
    yearly_events[year] = yearly_events.get(year, 0) + 1

for year in sorted(yearly_events.keys()):
    print(f"{year}: {yearly_events[year]:,} ä¸ªçƒ­æµªäº‹ä»¶")
```

## âš™ï¸ é…ç½®å‚æ•°è¯´æ˜

### å…³é”®å‚æ•°

| å‚æ•°                     | è¯´æ˜                | æ¨èå€¼    | å½±å“                                     |
| ------------------------ | ------------------- | --------- | ---------------------------------------- |
| `minimum_area_threshold` | æœ€å°é¢ç§¯é˜ˆå€¼ï¼ˆkmÂ²ï¼‰ | 100-1000  | è¿‡æ»¤å°å°ºåº¦å™ªå£°ï¼Œå€¼è¶Šå¤§äº‹ä»¶è¶Šå°‘           |
| `drought_threshold`      | ç™¾åˆ†ä½é˜ˆå€¼          | 90p       | çƒ­æµªå®šä¹‰æ ‡å‡†ï¼Œ90p è¡¨ç¤ºè¶…è¿‡ 90%çš„å†å²åŒæœŸ |
| `start_year/end_year`    | åˆ†ææ—¶é—´èŒƒå›´        | 2011-2020 | æ•°æ®è¦†ç›–çš„æ—¶é—´æ®µ                         |

### æ€§èƒ½ä¼˜åŒ–

- **å¹¶è¡Œæ ¸å¿ƒæ•°**ï¼šæ ¹æ® CPU æ ¸å¿ƒæ•°è°ƒæ•´ `-np` å‚æ•°
- **å†…å­˜ä½¿ç”¨**ï¼šå¤§æ•°æ®é›†å»ºè®®å¢åŠ ç³»ç»Ÿå†…å­˜
- **å­˜å‚¨ç©ºé—´**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿç£ç›˜ç©ºé—´å­˜å‚¨ä¸­é—´æ–‡ä»¶

## ğŸ› å¸¸è§é—®é¢˜

### 1. MPI é”™è¯¯

**é—®é¢˜**ï¼š`Fatal error in MPI_Init_thread: gethostbyname failed`

**è§£å†³**ï¼šä½¿ç”¨ `-host localhost` å‚æ•°

```bash
mpirun -host localhost -np 4 python src/02_calculate_heatwave_clusters_parallel.py
```

### 2. å†…å­˜ä¸è¶³

**é—®é¢˜**ï¼šå¤„ç†å¤§æ•°æ®é›†æ—¶å†…å­˜æº¢å‡º

**è§£å†³**ï¼š

- å‡å°‘å¹¶è¡Œæ ¸å¿ƒæ•°
- å¢åŠ ç³»ç»Ÿå†…å­˜
- è€ƒè™‘åˆ†æ—¶æ®µå¤„ç†

### 3. æ–‡ä»¶è·¯å¾„é”™è¯¯

**é—®é¢˜**ï¼šæ‰¾ä¸åˆ°è¾“å…¥æ–‡ä»¶

**è§£å†³**ï¼š

- æ£€æŸ¥ `definitions.yaml` ä¸­çš„è·¯å¾„é…ç½®
- ç¡®ä¿æ•°æ®æ–‡ä»¶å­˜åœ¨ä¸”å¯è¯»
- ä½¿ç”¨ç»å¯¹è·¯å¾„é¿å…ç›¸å¯¹è·¯å¾„é—®é¢˜

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

åŸºäºä¸­å›½åŒºåŸŸ ERA5 æ•°æ®ï¼ˆ2011-2020 å¹´ï¼‰çš„å…¸å‹æ€§èƒ½ï¼š

- **æ•°æ®è§„æ¨¡**ï¼š201Ã—161 æ ¼ç‚¹ï¼Œ1510 ä¸ªæ—¶é—´æ­¥
- **å¤„ç†æ—¶é—´**ï¼šçº¦ 2-4 å°æ—¶ï¼ˆ4 æ ¸å¿ƒå¹¶è¡Œï¼‰
- **è¾“å‡ºäº‹ä»¶**ï¼šçº¦ 7 ä¸‡ä¸ªçƒ­æµªäº‹ä»¶
- **å­˜å‚¨éœ€æ±‚**ï¼šçº¦ 500MB ä¸­é—´æ–‡ä»¶ + 200MB æœ€ç»ˆç»“æœ

## ğŸ“š æŠ€æœ¯ç»†èŠ‚

### çƒ­æµªå®šä¹‰

1. **æ¸©åº¦é˜ˆå€¼**ï¼šæ—¥å¹³å‡æ¸©åº¦è¶…è¿‡å†å²åŒæœŸ 90 ç™¾åˆ†ä½
2. **æŒç»­æ—¶é—´**ï¼šè‡³å°‘è¿ç»­ 3 å¤©
3. **ç©ºé—´è¿ç»­æ€§**ï¼šç›¸é‚»æ ¼ç‚¹æ¸©åº¦å‡è¶…è¿‡é˜ˆå€¼

### èšç±»ç®—æ³•

- åŸºäº 8 é‚»åŸŸè¿é€šæ€§åˆ†æ
- ä½¿ç”¨åŠ æƒè´¨å¿ƒè®¡ç®—èšç±»ä¸­å¿ƒ
- è€ƒè™‘åœ°çƒæ›²ç‡çš„é¢ç§¯è®¡ç®—

### è¿½è¸ªç®—æ³•

- åŸºäºç©ºé—´é‡å åº¦çš„äº‹ä»¶åŒ¹é…
- è·¨å¹´è¾¹ç•Œè‡ªåŠ¨é‡ç½®
- æ”¯æŒäº‹ä»¶åˆ†è£‚å’Œåˆå¹¶

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œè¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶ã€‚
